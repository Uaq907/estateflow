# 📋 سيناريو إشعارات المصروفات - دليل تفصيلي

## 🎯 كيف تعمل إشعارات المصروفات؟

---

## 👥 الأشخاص في السيناريو

### **1. الموظف (أحمد):**
- 📝 يقدم المصروفات
- 🔔 يستقبل إشعارات عن مصروفاته فقط (موافقة/رفض/إرجاع)

### **2. المدير (محمد):**
- ✅ لديه صلاحية `expenses:approve`
- 🔔 يستقبل إشعارات عن جميع المصروفات الجديدة
- ✅ يوافق أو يرفض أو يُرجع المصروفات

### **3. موظف آخر (سارة):**
- 📝 تقدم مصروفاتها الخاصة
- 🔔 تستقبل إشعارات عن مصروفاتها فقط
- ❌ لا ترى مصروفات الموظفين الآخرين

---

## 🎬 السيناريو الكامل

---

## المشهد 1️⃣: أحمد يقدم مصروف صيانة

### **⏰ الوقت:** 9:00 صباحاً

### **الإجراء:**
```
أحمد يفتح:
http://localhost:5000/dashboard/expenses

يضغط: [+ إضافة مصروف جديد]

يملأ النموذج:
┌─────────────────────────────────┐
│ الفئة: صيانة                   │
│ المبلغ: AED 750                │
│ الوصف: إصلاح مكيف الوحدة 201  │
│ الإيصال: [صورة محملة]          │
└─────────────────────────────────┘

يضغط: [إرسال للموافقة]
```

### **✅ ما يحدث:**

#### **1. يُحفظ المصروف في قاعدة البيانات**
```sql
INSERT INTO expenses (
    employeeId = 'ahmed-123',
    category = 'صيانة',
    amount = 750,
    status = 'Submitted'
)
```

#### **2. يُرسل إشعار للمدراء فقط**

**المدير محمد يستلم:**

```
┌─────────────────────────────────────┐
│ 🔔 Header Notification              │
├─────────────────────────────────────┤
│ 📋 مصروف جديد مقدم                 │
│                                     │
│ الموظف: أحمد محمد                  │
│ الفئة: صيانة                       │
│ المبلغ: AED 750                    │
│                                     │
│ منذ الآن                            │
│ [عرض التفاصيل →]                   │
└─────────────────────────────────────┘
```

**وعلى Telegram (إذا مكوّن):**
```
📱 Telegram - 9:00
──────────────────

📋 New Expense Submitted

Employee: أحمد محمد
Category: صيانة
Amount: AED 750
Description: إصلاح مكيف الوحدة 201

Please review it in the dashboard.
```

#### **3. أحمد لا يستلم إشعار**
```
❌ أحمد لا يستقبل إشعار
(لأنه هو من قدم المصروف)
```

#### **4. سارة لا تستلم إشعار**
```
❌ سارة لا تستقبل إشعار
(ليس لديها صلاحية الموافقة)
```

---

## المشهد 2️⃣: المدير محمد يراجع ويوافق

### **⏰ الوقت:** 10:30 صباحاً (بعد ساعة ونصف)

### **الإجراء:**
```
محمد يفتح:
http://localhost:5000/dashboard/expenses

يرى المصروف الجديد:
┌─────────────────────────────────┐
│ 📋 EXP-001                      │
│ أحمد محمد - صيانة              │
│ AED 750                         │
│ الحالة: Submitted              │
│                                 │
│ [عرض] [✅ موافقة] [❌ رفض]    │
└─────────────────────────────────┘

يضغط: [✅ موافقة]
```

### **✅ ما يحدث:**

#### **1. يُحدّث المصروف في قاعدة البيانات**
```sql
UPDATE expenses 
SET status = 'Approved',
    approvedBy = 'mohamed-456',
    approvedAt = NOW()
WHERE id = 'exp-001'
```

#### **2. يُرسل إشعار لأحمد فقط**

**أحمد يستلم:**

```
┌─────────────────────────────────────┐
│ 🔔 Header Notification              │
├─────────────────────────────────────┐
│ ✅ تمت الموافقة على مصروفك         │
│                                     │
│ رقم المصروف: EXP-001               │
│ الفئة: صيانة                       │
│ المبلغ: AED 750                    │
│                                     │
│ الموافق: محمد أحمد (المدير)        │
│                                     │
│ منذ الآن                            │
│ [عرض التفاصيل →]                   │
└─────────────────────────────────────┘
```

**وعلى Telegram (إذا مكوّن):**
```
📱 Telegram - 10:30
──────────────────

✅ Expense Approved!

Your expense request for صيانة 
(AED 750) has been approved.
```

#### **3. المدير محمد لا يستلم إشعار**
```
❌ محمد لا يستقبل إشعار
(هو من وافق على المصروف)
```

#### **4. سارة لا تستلم إشعار**
```
❌ سارة لا تستقبل إشعار
(ليس مصروفها)
```

---

## المشهد 3️⃣: سارة تقدم مصروف مرتفع

### **⏰ الوقت:** 11:00 صباحاً

### **الإجراء:**
```
سارة تفتح:
http://localhost:5000/dashboard/expenses

تقدم مصروف:
┌─────────────────────────────────┐
│ الفئة: تنظيف                   │
│ المبلغ: AED 2,500              │
│ الوصف: تنظيف شامل للمبنى      │
└─────────────────────────────────┘
```

### **✅ ما يحدث:**

#### **1. المدير محمد يستلم إشعار:**

```
┌─────────────────────────────────────┐
│ 🔔 [2]                              │
├─────────────────────────────────────┤
│ 📋 مصروف جديد مقدم                 │
│                                     │
│ الموظف: سارة خالد                  │
│ الفئة: تنظيف                       │
│ المبلغ: AED 2,500                  │
│                                     │
│ [عرض]                               │
└─────────────────────────────────────┘
```

#### **2. أحمد لا يستلم إشعار**
```
❌ أحمد لا يستقبل إشعار
(ليس لديه صلاحية الموافقة)
```

---

## المشهد 4️⃣: المدير يرفض مصروف سارة

### **⏰ الوقت:** 11:30 صباحاً

### **الإجراء:**
```
محمد يراجع المصروف:
المبلغ مرتفع جداً!

يضغط: [❌ رفض]

يكتب ملاحظات:
┌─────────────────────────────────┐
│ ملاحظات المدير:                │
│ المبلغ أعلى من السقف المسموح   │
│ يرجى الحصول على 3 عروض أسعار  │
└─────────────────────────────────┘

يحفظ
```

### **✅ ما يحدث:**

#### **1. سارة تستلم إشعار رفض:**

```
┌─────────────────────────────────────┐
│ 🔔 Header Notification              │
├─────────────────────────────────────┤
│ ❌ تم رفض مصروفك                   │
│                                     │
│ رقم المصروف: EXP-002               │
│ الفئة: تنظيف                       │
│ المبلغ: AED 2,500                  │
│                                     │
│ ⚠️ سبب الرفض:                     │
│ المبلغ أعلى من السقف المسموح       │
│ يرجى الحصول على 3 عروض أسعار      │
│                                     │
│ [عرض] [تعديل]                      │
└─────────────────────────────────────┘
```

**وعلى Telegram:**
```
📱 Telegram - 11:30
──────────────────

❌ Expense Rejected

Your expense for تنظيف (AED 2,500) 
was rejected.

Manager Notes:
المبلغ أعلى من السقف المسموح
يرجى الحصول على 3 عروض أسعار
```

#### **2. أحمد لا يستلم إشعار**
```
❌ أحمد لا يستقبل إشعار
(ليس مصروفه)
```

---

## المشهد 5️⃣: سارة تعدل وتعيد التقديم

### **⏰ الوقت:** 2:00 مساءً

### **الإجراء:**
```
سارة تعدّل المصروف:
┌─────────────────────────────────┐
│ الفئة: تنظيف                   │
│ المبلغ: AED 1,200 (محدث ↓)    │
│ الوصف: تنظيف - عرض سعر أقل   │
│ المرفقات: 3 عروض أسعار        │
└─────────────────────────────────┘

تعيد التقديم
```

### **✅ ما يحدث:**

#### **1. المدير محمد يستلم إشعار جديد:**

```
┌─────────────────────────────────────┐
│ 🔔 [1]                              │
├─────────────────────────────────────┤
│ 📋 مصروف جديد مقدم                 │
│                                     │
│ الموظف: سارة خالد                  │
│ الفئة: تنظيف                       │
│ المبلغ: AED 1,200 ✅ (معدّل)       │
│ ملاحظة: تم تخفيض المبلغ            │
│                                     │
│ [عرض]                               │
└─────────────────────────────────────┘
```

#### **2. يوافق المدير:**
```
محمد يضغط: [✅ موافقة]
```

#### **3. سارة تستلم إشعار الموافقة:**

```
┌─────────────────────────────────────┐
│ 🔔 Header Notification              │
├─────────────────────────────────────┤
│ ✅ تمت الموافقة على مصروفك         │
│                                     │
│ الفئة: تنظيف                       │
│ المبلغ: AED 1,200                  │
│                                     │
│ الموافق: محمد أحمد                 │
│                                     │
│ [عرض] [طباعة]                      │
└─────────────────────────────────────┘
```

---

## 📊 جدول تدفق الإشعارات

| الحدث | من يستلم الإشعار | من لا يستلم |
|-------|------------------|-------------|
| **موظف يقدم مصروف** | ✅ المدراء الذين لديهم صلاحية `expenses:approve` | ❌ الموظف المقدم<br>❌ الموظفين الآخرين<br>❌ الموظفين بدون صلاحية |
| **مدير يوافق** | ✅ الموظف المقدم فقط | ❌ المدير<br>❌ الموظفين الآخرين |
| **مدير يرفض** | ✅ الموظف المقدم فقط | ❌ المدير<br>❌ الموظفين الآخرين |
| **مدير يُرجع للتعديل** | ✅ الموظف المقدم فقط | ❌ المدير<br>❌ الموظفين الآخرين |

---

## 🎯 أمثلة مفصلة

### **مثال 1: 5 موظفين في الشركة**

```
┌──────────────────────────────────┐
│ الموظفون:                        │
├──────────────────────────────────┤
│ 1. محمد (المدير العام)          │
│    ✅ لديه صلاحية الموافقة      │
│                                  │
│ 2. علي (مدير مالي)              │
│    ✅ لديه صلاحية الموافقة      │
│                                  │
│ 3. أحمد (موظف صيانة)            │
│    ❌ ليس لديه صلاحية           │
│                                  │
│ 4. سارة (موظفة تنظيف)           │
│    ❌ ليس لديها صلاحية          │
│                                  │
│ 5. فاطمة (موظفة إدارية)         │
│    ❌ ليس لديها صلاحية          │
└──────────────────────────────────┘
```

#### **سيناريو: أحمد يقدم مصروف**

**من يستلم إشعار:**
```
✅ محمد (مدير عام)      ← Header + Telegram
✅ علي (مدير مالي)      ← Header + Telegram
❌ أحمد (المقدم)        ← لا إشعار
❌ سارة                 ← لا إشعار
❌ فاطمة                ← لا إشعار
```

#### **سيناريو: محمد يوافق على مصروف أحمد**

**من يستلم إشعار:**
```
✅ أحمد (المقدم)        ← Header + Telegram
❌ محمد (الموافق)       ← لا إشعار
❌ علي                  ← لا إشعار
❌ سارة                 ← لا إشعار
❌ فاطمة                ← لا إشعار
```

---

### **مثال 2: يوم كامل من النشاط**

#### **9:00 - أحمد يقدم مصروف صيانة (AED 750)**
```
الإشعارات:
├─ محمد: 📋 مصروف جديد من أحمد (صيانة)
└─ علي: 📋 مصروف جديد من أحمد (صيانة)
```

#### **9:30 - سارة تقدم مصروف تنظيف (AED 500)**
```
الإشعارات:
├─ محمد: 📋 مصروف جديد من سارة (تنظيف)
└─ علي: 📋 مصروف جديد من سارة (تنظيف)
```

#### **10:00 - محمد يوافق على مصروف أحمد**
```
الإشعارات:
└─ أحمد: ✅ تمت الموافقة على مصروفك (صيانة)
```

#### **10:30 - علي يرفض مصروف سارة**
```
الإشعارات:
└─ سارة: ❌ تم رفض مصروفك (تنظيف)
```

#### **2:00 - سارة تعيد تقديم مصروف معدّل (AED 400)**
```
الإشعارات:
├─ محمد: 📋 مصروف جديد من سارة (تنظيف - معدّل)
└─ علي: 📋 مصروف جديد من سارة (تنظيف - معدّل)
```

#### **2:30 - محمد يوافق على مصروف سارة**
```
الإشعارات:
└─ سارة: ✅ تمت الموافقة على مصروفك (تنظيف)
```

---

## 🔐 الصلاحيات المطلوبة

### **لاستقبال إشعارات المصروفات الجديدة:**

```
الصلاحية المطلوبة:
expenses:approve

التحقق في الكود:
hasPermission(employee, 'expenses:approve')
```

### **كيف تعطي صلاحية:**

```
1. افتح: /dashboard/employees
2. عدّل الموظف
3. في قسم "الصلاحيات":
   ☑️ الموافقة على المصروفات (expenses:approve)
4. احفظ
```

---

## 🎨 أنواع الإشعارات البصرية

### **1. مصروف جديد (للمدراء):**
```
🔵 خلفية زرقاء فاتحة
📋 أيقونة مستند
[عرض التفاصيل]
```

### **2. موافقة (للموظف):**
```
🟢 خلفية خضراء فاتحة
✅ أيقونة صح
[عرض التفاصيل]
```

### **3. رفض (للموظف):**
```
🔴 خلفية حمراء فاتحة
❌ أيقونة X
ملاحظات المدير
[عرض] [تعديل]
```

---

## 📱 تكوين الإشعارات

### **للموظفين:**

```
http://localhost:5000/dashboard/user-preferences

┌──────────────────────────────┐
│ 🔔 تفضيلات الإشعارات       │
├──────────────────────────────┤
│ ☐ مصروف جديد مقدم           │
│   (رمادي - غير متاح لك)     │
│                              │
│ ☑️ مصروف موافق عليه         │
│   ✅ فعّل هذا                │
│                              │
│ ☑️ مصروف مرفوض              │
│   ✅ فعّل هذا                │
└──────────────────────────────┘
```

### **للمدراء:**

```
http://localhost:5000/dashboard/user-preferences

┌──────────────────────────────┐
│ 🔔 تفضيلات الإشعارات       │
├──────────────────────────────┤
│ ☑️ مصروف جديد مقدم          │
│   ✅ فعّل هذا                │
│                              │
│ ☑️ مصروف موافق عليه         │
│   (إذا قدمت مصروف)          │
│                              │
│ ☑️ مصروف مرفوض              │
│   (إذا قدمت مصروف)          │
└──────────────────────────────┘
```

---

## 🔍 التحقق من استلام الإشعارات

### **للموظف:**

```
1. قدم مصروف تجريبي
2. انتظر موافقة المدير
3. تحقق من Header:
   🔔 [1] ← يجب أن ترى رقم
4. اضغط على الجرس
5. يجب أن ترى إشعار الموافقة
```

### **للمدير:**

```
1. انتظر موظف يقدم مصروف
   (أو اطلب من موظف تقديم تجريبي)
2. تحقق من Header:
   🔔 [1] ← يجب أن ترى رقم
3. اضغط على الجرس
4. يجب أن ترى "مصروف جديد مقدم"
```

---

## 📊 إحصائيات السيناريو

### **في يوم عمل عادي:**

```
┌────────────────────────────────┐
│ النشاط                | العدد │
├────────────────────────────────┤
│ مصروفات مقدمة         | 12   │
│ إشعارات للمدراء       | 24   │
│   (2 مدير × 12 مصروف)         │
│                               │
│ موافقات                | 10   │
│ إشعارات للموظفين      | 10   │
│                               │
│ رفض                    | 2    │
│ إشعارات للموظفين      | 2    │
├────────────────────────────────┤
│ إجمالي الإشعارات      | 36   │
└────────────────────────────────┘
```

---

## ✅ قائمة التحقق النهائية

### **للموظفين:**
```
☑️ فعّلت إشعار "موافقة على مصروفي"
☑️ فعّلت إشعار "رفض مصروفي"
☑️ (اختياري) كوّنت Telegram الخاص بي
☑️ أستلم إشعارات عن مصروفاتي فقط
```

### **للمدراء:**
```
☑️ فعّلت إشعار "مصروف جديد مقدم"
☑️ أستلم إشعارات عن جميع المصروفات الجديدة
☑️ أراجع المصروفات بسرعة
☑️ أكتب ملاحظات واضحة عند الرفض
```

---

## 🎉 الخلاصة

### **القواعد الأساسية:**

```
📋 مصروف جديد:
   من: أي موظف
   إلى: المدراء فقط ✅
   
✅ موافقة:
   من: مدير
   إلى: الموظف المقدم فقط ✅
   
❌ رفض:
   من: مدير
   إلى: الموظف المقدم فقط ✅
```

---

## 📞 للمساعدة

- 📚 [الدليل الكامل](./EXPENSE_NOTIFICATIONS_GUIDE.md)
- 📱 [إعداد Telegram](./TELEGRAM_SETUP_GUIDE.md)
- ⚙️ [صفحة التفضيلات](http://localhost:5000/dashboard/user-preferences)

---

**🎯 النظام يعمل بالضبط كما طلبت!**

**تاريخ التحديث:** أكتوبر 2025

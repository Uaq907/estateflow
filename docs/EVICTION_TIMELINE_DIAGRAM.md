# مخطط تسلسل زمني لعملية إنشاء طلب إخلاء

## 📅 التسلسل الزمني للعملية

```
T0: المستخدم في صفحة الإخلاء
    ↓
    [ينقر على "إنشاء طلب إخلاء من نموذج"]
    ↓

T1: فتح Dialog اختيار المستأجر
    ┌─────────────────────────────────┐
    │  اختيار المستأجر                │
    │  ────────────────               │
    │  ☐ أحمد محمد علي               │
    │  ☐ محمد عبدالله                │
    │  ☐ شركة الخليج التجارية       │
    │                                 │
    │  [إلغاء]  [التالي →]           │
    └─────────────────────────────────┘
    ↓
    [المستخدم يختار مستأجر]
    ↓

T2: إرسال طلب API
    Frontend → Backend
    GET /api/eviction/tenant-data?tenantId=T-001
    
    ⏱️ الوقت المتوقع: 200-500ms
    ↓

T3: معالجة في Backend
    ┌─────────────────────────────────┐
    │  1. التحقق من الصلاحيات         │
    │  2. الاتصال بقاعدة البيانات     │
    │  3. جلب بيانات المستأجر         │
    │  4. جلب بيانات العقد النشط     │
    │  5. حساب المتأخرات             │
    │  6. جلب بيانات المالك           │
    │  7. تجميع البيانات              │
    └─────────────────────────────────┘
    ↓

T4: استلام البيانات
    Backend → Frontend
    {
      tenant: {...},
      lease: {...},
      arrears: {...},
      owner: {...}
    }
    ↓

T5: حفظ مؤقت في sessionStorage
    sessionStorage.setItem('evictionData', JSON.stringify(data))
    ↓

T6: التوجيه لصفحة النماذج
    router.push('/dashboard/legal/petition-templates?action=new&type=eviction')
    
    ⏱️ الوقت المتوقع: 100-300ms
    ↓

T7: تحميل صفحة النماذج
    - تحميل المكونات
    - تحميل قائمة النماذج
    - تشغيل useEffect
    ↓

T8: قراءة البيانات من sessionStorage
    const data = sessionStorage.getItem('evictionData')
    ↓

T9: تحديد نموذج الإخلاء
    const template = petitionTemplates.find(t => t.category === 'إخلاء')
    ↓

T10: ملء النموذج تلقائياً
     ┌─────────────────────────────────┐
     │  استبدال المتغيرات:             │
     │  ────────────────               │
     │  [اسم_المدعي] → أحمد الخالدي   │
     │  [اسم_المدعى_عليه] → محمد علي  │
     │  [رقم_العقد] → TC-2024-1234    │
     │  [المبلغ_المتأخر] → 45,000     │
     │  ... (جميع المتغيرات الأخرى)   │
     └─────────────────────────────────┘
     ↓

T11: فتح محرر النموذج
     setShowEditor(true)
     setEditingTemplate(filledTemplate)
     ↓

T12: عرض النموذج المملوء
     ┌─────────────────────────────────┐
     │  نموذج دعوى إخلاء              │
     │  ═══════════════════            │
     │                                 │
     │  المدعي: أحمد الخالدي          │
     │  الهوية: 784-1234-5678901-2    │
     │                                 │
     │  المدعى عليه: محمد علي         │
     │  الهوية: 784-9876-5432109-8    │
     │                                 │
     │  رقم العقد: TC-2024-1234       │
     │  المبلغ المتأخر: 45,000 درهم   │
     │  ...                            │
     │                                 │
     │  [حفظ]  [تصدير PDF]  [إلغاء]  │
     └─────────────────────────────────┘
     ↓

T13: المستخدم يراجع ويعدل
     - قراءة النموذج
     - تعديل أي بيانات إذا لزم
     - إضافة ملاحظات
     ↓

T14: حفظ النموذج النهائي
     [المستخدم ينقر على "حفظ"]
     ↓
     حفظ في قاعدة البيانات
     ↓

T15: تأكيد النجاح
     ✅ تم حفظ طلب الإخلاء بنجاح
```

---

## ⏱️ الوقت الإجمالي المتوقع

| المرحلة | الوقت |
|---------|-------|
| T0 → T1 | فوري (< 50ms) |
| T1 → T2 | حسب اختيار المستخدم |
| T2 → T4 | 200-500ms (API) |
| T4 → T6 | 50-100ms |
| T6 → T7 | 100-300ms (تحميل صفحة) |
| T7 → T12 | 50-200ms (معالجة) |
| T12 → T13 | حسب المستخدم |
| T13 → T15 | 200-400ms (حفظ) |
| **المجموع** | **~1-2 ثانية** (بدون وقت المستخدم) |

---

## 🎯 نقاط القرار (Decision Points)

### **نقطة القرار 1: اختيار المستأجر**
```
هل للمستأجر عقد نشط؟
├─ نعم → المتابعة
└─ لا → عرض رسالة خطأ: "لا يوجد عقد نشط لهذا المستأجر"
```

### **نقطة القرار 2: المتأخرات**
```
هل توجد متأخرات؟
├─ نعم → إضافة تفاصيل المتأخرات
└─ لا → عرض "0 درهم" كمتأخرات
```

### **نقطة القرار 3: بيانات المالك**
```
هل تم تعيين مالك للعقار؟
├─ نعم → استخدام بيانات المالك
└─ لا → استخدام "غير محدد" كقيمة افتراضية
```

---

## 🔄 معالجة الأخطاء (Error Handling)

### **السيناريو 1: فشل API**
```
T2 (API Request)
    ↓
    ❌ Error: Network failure
    ↓
    عرض رسالة: "فشل في الاتصال بالخادم"
    ↓
    [إعادة المحاولة]  [إلغاء]
```

### **السيناريو 2: مستأجر بدون عقد**
```
T3 (Backend Processing)
    ↓
    ❌ No active lease found
    ↓
    Backend → Frontend: { error: "No active lease" }
    ↓
    عرض رسالة: "لا يوجد عقد نشط لهذا المستأجر"
```

### **السيناريو 3: بيانات ناقصة**
```
T10 (Fill Template)
    ↓
    ⚠️ Warning: Some fields are empty
    ↓
    ملء الحقول الناقصة بـ "[غير محدد]"
    ↓
    عرض تنبيه: "بعض البيانات غير متوفرة، يرجى المراجعة"
```

---

## 📊 تدفق البيانات التفصيلي

```
┌─────────────────────────────────────────────────────────┐
│                    User Interface                        │
│  ┌──────────────┐         ┌──────────────┐             │
│  │ Eviction Page│         │ Templates Pg │             │
│  │              │────────→│              │             │
│  └──────┬───────┘         └──────┬───────┘             │
└─────────┼──────────────────────────┼──────────────────────┘
          │                          │
          │ 1. Select Tenant         │ 4. Auto-fill
          ↓                          ↓
┌─────────────────────────────────────────────────────────┐
│                    Frontend Logic                        │
│  ┌──────────────┐         ┌──────────────┐             │
│  │ State Mgmt   │         │ Session Stor │             │
│  │              │←───────→│              │             │
│  └──────┬───────┘         └──────┬───────┘             │
└─────────┼──────────────────────────┼──────────────────────┘
          │ 2. API Call              │ 3. Store Data
          ↓                          ↑
┌─────────────────────────────────────────────────────────┐
│                     API Layer                            │
│  ┌──────────────┐                                       │
│  │ /api/eviction│                                       │
│  │ /tenant-data │                                       │
│  └──────┬───────┘                                       │
└─────────┼──────────────────────────────────────────────────┘
          │
          ↓
┌─────────────────────────────────────────────────────────┐
│                   Database Layer                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │ Tenants  │  │  Leases  │  │ Payments │             │
│  │  Table   │  │  Table   │  │  Table   │             │
│  └──────────┘  └──────────┘  └──────────┘             │
└─────────────────────────────────────────────────────────┘
```

---

## 🎨 حالات الواجهة (UI States)

### **الحالة 1: الانتظار (Loading)**
```
┌─────────────────────────────────┐
│  ⏳ جاري تحميل بيانات المستأجر  │
│                                 │
│  [████████░░░░░░░░░░] 40%      │
└─────────────────────────────────┘
```

### **الحالة 2: النجاح (Success)**
```
┌─────────────────────────────────┐
│  ✅ تم تحميل البيانات بنجاح     │
│                                 │
│  جاري التوجيه لصفحة النماذج...  │
└─────────────────────────────────┘
```

### **الحالة 3: الخطأ (Error)**
```
┌─────────────────────────────────┐
│  ❌ فشل في تحميل البيانات        │
│                                 │
│  السبب: لا يوجد عقد نشط         │
│                                 │
│  [إعادة المحاولة]  [إغلاق]     │
└─────────────────────────────────┘
```

---

## 📱 تجربة المستخدم (UX Flow)

```
1. البداية
   ↓
2. صفحة الإخلاء
   │
   ├─ عرض قائمة طلبات الإخلاء الحالية
   │
   └─ زر "إنشاء طلب إخلاء من نموذج" ← واضح ومميز
   ↓
3. Dialog اختيار المستأجر
   │
   ├─ حقل بحث
   │
   ├─ قائمة منسدلة مع المستأجرين
   │  └─ عرض: الاسم، الاسم التجاري، رقم العقد
   │
   └─ أزرار: [إلغاء] [التالي]
   ↓
4. شاشة تحميل (Loading)
   │
   └─ رسالة: "جاري جلب البيانات..."
   ↓
5. التوجيه التلقائي
   │
   └─ انتقال سلس لصفحة النماذج
   ↓
6. صفحة النماذج (مملوءة تلقائياً)
   │
   ├─ عرض النموذج في المحرر
   │
   ├─ جميع الحقول مملوءة
   │
   ├─ إمكانية التعديل
   │
   └─ أزرار: [حفظ] [تصدير] [إلغاء]
   ↓
7. المراجعة والتعديل
   │
   └─ المستخدم يراجع ويعدل حسب الحاجة
   ↓
8. الحفظ
   │
   └─ رسالة تأكيد: "تم حفظ طلب الإخلاء بنجاح"
   ↓
9. النهاية
   └─ العودة لصفحة الإخلاء أو البقاء في المحرر
```

---

## 🔐 التحقق من الصلاحيات

```
في كل مرحلة، يتم التحقق من:

T0: صلاحية الوصول لصفحة الإخلاء
    ↓
    hasPermission('legal:eviction:read')

T2: صلاحية قراءة بيانات المستأجرين
    ↓
    hasPermission('tenants:read')

T2: صلاحية قراءة بيانات العقود
    ↓
    hasPermission('leases:read')

T6: صلاحية إنشاء نماذج قانونية
    ↓
    hasPermission('legal:templates:create')

T14: صلاحية حفظ طلبات الإخلاء
     ↓
     hasPermission('legal:eviction:create')
```

---

## 💡 نصائح للتطوير

1. **استخدم TypeScript** لضمان أمان الأنواع
2. **أضف Loading States** لتحسين تجربة المستخدم
3. **استخدم Error Boundaries** لمعالجة الأخطاء
4. **أضف Logging** لتتبع المشاكل
5. **اختبر جميع السيناريوهات** (نجاح، فشل، بيانات ناقصة)
6. **استخدم Debouncing** في حقل البحث
7. **أضف Caching** للبيانات المكررة
8. **استخدم Optimistic Updates** عند الإمكان

---

**📌 ملاحظة:** هذا المخطط يوضح التسلسل المثالي. في الواقع، قد تختلف بعض الأوقات حسب سرعة الشبكة والخادم.

# ุงูุณููุงุฑูู ุงูุญุงูู: ุฅุถุงูุฉ ูุตุฑูู ุฌุฏูุฏ ูู EstateFlow

## ๐ **ูุธุฑุฉ ุนุงูุฉ**

ุงููุธุงู ุงูุญุงูู ูุฅุฏุงุฑุฉ ุงููุตุฑููุงุช ุจุณูุท ููุจุงุดุฑุ ูุชููู ูู ูุฑุญูุชูู ุฑุฆูุณูุชูู: ุงูุฅูุดุงุก ูุงูููุงููุฉ.

---

## ๐ **ุงููุฑุงุญู ุงูุญุงููุฉ**

### 1๏ธโฃ **ุฅูุดุงุก ูุตุฑูู ุฌุฏูุฏ (Create Expense)**

**ูู ูููู ุจูุง:** ุฃู ููุธู ูุฏูู ุตูุงุญูุฉ `expenses:create`

**ุงูุจูุงูุงุช ุงููุทููุจุฉ:**
- **ุงูุนูุงุฑ (Property)** - ุฅูุฒุงูู
- **ุงููุญุฏุฉ (Unit)** - ุงุฎุชูุงุฑู
- **ุงููุฆุฉ (Category)** - ุฅูุฒุงูู
  - Maintenance (ุตูุงูุฉ)
  - Utilities (ูุฑุงูู)
  - Marketing (ุชุณููู)
  - Supplies (ูุดุชุฑูุงุช)
  - Legal (ูุงููููุฉ)
  - Other (ุฃุฎุฑู)
- **ุงููุตู (Description)** - ุฅูุฒุงูู
- **ุงูููุฑุฏ (Supplier)** - ุงุฎุชูุงุฑู
- **ุงูุฑูู ุงูุถุฑูุจู (Tax Number)** - ุงุฎุชูุงุฑู
- **ุงููุจูุบ ุงูุฃุณุงุณู (Base Amount)** - ุฅูุฒุงูู
- **ุฎุงุถุน ูุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (VAT)** - checkbox
  - ุฅุฐุง ุชู ุงูุชูุนููุ ูุถุงู 5% ุชููุงุฆูุงู
- **ุงูุฅูุตุงู (Receipt)** - ุงุฎุชูุงุฑู (ุฑูุน ููู)

---

### 2๏ธโฃ **ุงูุญูุธ ูุงูุฅุฑุณุงู**

ุนูุฏ ุงูุถุบุท ุนูู **"Submit"**:

1. **ุฑูุน ุงูุฅูุตุงู (ุฅู ูุฌุฏ):**
   - ูุชู ุฑูุน ุงูููู ุฅูู `/uploads/expenses_receipts/`
   - ุงูุญุฏ ุงูุฃูุตู ููููู: 5MB

2. **ุญุณุงุจ ุงููุจูุบ ุงูููุงุฆู:**
   ```javascript
   let finalAmount = baseAmount;
   let taxAmount = 0;
   
   if (isVat) {
       taxAmount = baseAmount * 0.05;  // 5% VAT
       finalAmount = baseAmount + taxAmount;
   }
   ```

3. **ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
   ```sql
   INSERT INTO expenses (
       propertyId,
       unitId,
       employeeId,
       category,
       description,
       supplier,
       taxNumber,
       isVat,
       baseAmount,
       amount,           -- ุงููุจูุบ ุงูููุงุฆู (ุดุงูู ุงูุถุฑูุจุฉ)
       taxAmount,
       receiptUrl,
       status,          -- 'Pending' (ุงูุงูุชุฑุงุถู)
       createdAt
   )
   ```

4. **ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ:** `Pending` (ููุฏ ุงูุงูุชุธุงุฑ)

5. **ุชุณุฌูู ูู Activity Log:**
   - ุงูููุธู ุงูุฐู ุฃูุดุฃ ุงููุตุฑูู
   - ุงูููุน: `CREATE_EXPENSE`
   - ุงูุชูุงุตูู: ุงููุฆุฉ ูุงููุจูุบ

6. **ุฅุฑุณุงู ุฅุดุนุงุฑ Telegram:**
   - **ุฅูู:** ููุงุฉ ุงูุฅุดุนุงุฑุงุช ุงูุฅุฏุงุฑูุฉ (System-wide)
   - **ุงูุฑุณุงูุฉ:**
     ```
     *New Expense Submitted*
     
     *Employee:* [ุงุณู ุงูููุธู]
     *Category:* [ุงููุฆุฉ]
     *Amount:* AED [ุงููุจูุบ ุงูููุงุฆู]
     *Description:* [ุงููุตู]
     
     Please review and approve/reject.
     ```

---

### 3๏ธโฃ **ุงููุฑุงุฌุนุฉ ูุงูููุงููุฉ (Review & Approval)**

**ูู ูููู ุจูุง:** ููุธููู ูุฏููู ุตูุงุญูุฉ `expenses:approve`

**ุงูุฎูุงุฑุงุช ุงููุชุงุญุฉ:**

#### โ **ุฃ) ุงูููุงููุฉ (Approve)**
- ูุชู ุชุญุฏูุซ ุญุงูุฉ ุงููุตุฑูู ุฅูู: `Approved`
- ุฅุฑุณุงู ุฅุดุนุงุฑ Telegram ููููุธู ููุฏู ุงูุทูุจ:
  ```
  *Expense Approved*
  
  *Expense ID:* [ID]
  *Amount:* AED [ุงููุจูุบ]
  *Approved by:* [ุงุณู ุงููุฑุงุฌุน]
  
  Your expense has been approved.
  ```
- ุชุณุฌูู ูู Activity Log

#### โ **ุจ) ุงูุฑูุถ (Reject)**
- ูุชู ุชุญุฏูุซ ุญุงูุฉ ุงููุตุฑูู ุฅูู: `Rejected`
- ุฅุฑุณุงู ุฅุดุนุงุฑ Telegram ููููุธู ููุฏู ุงูุทูุจ:
  ```
  *Expense Rejected*
  
  *Expense ID:* [ID]
  *Amount:* AED [ุงููุจูุบ]
  *Rejected by:* [ุงุณู ุงููุฑุงุฌุน]
  
  Your expense has been rejected.
  ```
- ุชุณุฌูู ูู Activity Log

#### ๐ **ุฌ) ูุญุชุงุฌ ุชุตุญูุญ (Needs Correction)**
- ูุชู ุชุญุฏูุซ ุญุงูุฉ ุงููุตุฑูู ุฅูู: `Needs Correction`
- ุงูููุธู ุงูุฐู ุฃูุดุฃ ุงููุตุฑูู ููููู **ุชุนุฏููู ููุท**
- ุจุนุฏ ุงูุชุนุฏููุ ุชุนูุฏ ุงูุญุงูุฉ ุฅูู `Pending` ูููุฑุงุฌุนุฉ ูุฑุฉ ุฃุฎุฑู

---

## ๐ **ุญุงูุงุช ุงููุตุฑูู (Expense Statuses)**

| ุงูุญุงูุฉ | ุงููุตู | ูู ููููู ุงูุชุนุฏูู |
|-------|-------|------------------|
| `Pending` | ููุฏ ุงูุงูุชุธุงุฑ ูููุฑุงุฌุนุฉ | ูุง ุฃุญุฏ |
| `Approved` | ููุงูู ุนููู | ูุง ุฃุญุฏ |
| `Rejected` | ูุฑููุถ | ูุง ุฃุญุฏ |
| `Needs Correction` | ูุญุชุงุฌ ุชุตุญูุญ | ุงูููุธู ุตุงุญุจ ุงููุตุฑูู ููุท |

---

## ๐ **ุงูุตูุงุญูุงุช (Permissions)**

| ุงูุฅุฌุฑุงุก | ุงูุตูุงุญูุฉ ุงููุทููุจุฉ |
|---------|-------------------|
| ุฅูุดุงุก ูุตุฑูู | `expenses:create` |
| ุนุฑุถ ุงููุตุฑููุงุช | `expenses:read` |
| ุงูููุงููุฉ/ุงูุฑูุถ/ุทูุจ ุงูุชุตุญูุญ | `expenses:approve` |
| ุชุนุฏูู (ุจุนุฏ ุทูุจ ุงูุชุตุญูุญ) | `expenses:create` + ุฃู ูููู ุตุงุญุจ ุงููุตุฑูู |
| ุญุฐู | `expenses:delete` |

---

## ๐ง **ุงูุฅุดุนุงุฑุงุช (Notifications)**

### **1. ุนูุฏ ุฅูุดุงุก ูุตุฑูู:**
- **ุฅูู:** ููุงุฉ Telegram ุงูุฅุฏุงุฑูุฉ (System-wide)
- **ุงููุญุชูู:** ุชูุงุตูู ุงููุตุฑูู ุงูุฌุฏูุฏ

### **2. ุนูุฏ ุงูููุงููุฉ:**
- **ุฅูู:** ุงูููุธู ุตุงุญุจ ุงููุตุฑูู (Personal notification)
- **ุงููุญุชูู:** ุฅุดุนุงุฑ ุจุงูููุงููุฉ

### **3. ุนูุฏ ุงูุฑูุถ:**
- **ุฅูู:** ุงูููุธู ุตุงุญุจ ุงููุตุฑูู (Personal notification)
- **ุงููุญุชูู:** ุฅุดุนุงุฑ ุจุงูุฑูุถ

### **4. ุนูุฏ ุทูุจ ุงูุชุตุญูุญ:**
- ูุง ููุฌุฏ ุฅุดุนุงุฑ ุญุงููุงู (ูููู ุฅุถุงูุชู)

---

## ๐๏ธ **ูุงุนุฏุฉ ุงูุจูุงูุงุช (Database Structure)**

### **ุฌุฏูู `expenses`:**

```sql
CREATE TABLE expenses (
  id VARCHAR(255) PRIMARY KEY,
  propertyId VARCHAR(255) NOT NULL,
  unitId VARCHAR(255),
  employeeId VARCHAR(255) NOT NULL,
  category VARCHAR(100) NOT NULL,
  description TEXT NOT NULL,
  supplier VARCHAR(255),
  taxNumber VARCHAR(255),
  isVat BOOLEAN DEFAULT FALSE,
  baseAmount DECIMAL(10, 2) NOT NULL,
  amount DECIMAL(10, 2) NOT NULL,          -- baseAmount + tax
  taxAmount DECIMAL(10, 2) DEFAULT 0,
  receiptUrl VARCHAR(500),
  status ENUM('Pending', 'Approved', 'Rejected', 'Needs Correction') DEFAULT 'Pending',
  submittedBy VARCHAR(255),
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (propertyId) REFERENCES properties(id) ON DELETE CASCADE,
  FOREIGN KEY (employeeId) REFERENCES employees(id) ON DELETE CASCADE
);
```

---

## ๐ **ูุซุงู ุนูู ุงูุณููุงุฑูู ุงููุงูู**

### **ุงูุณููุงุฑูู ุงูุนุงุฏู:**

1. **ุงูููุธู "ุฃุญูุฏ"** ููุชุญ ุตูุญุฉ ุงููุตุฑููุงุช
2. ูุถุบุท **"Add Expense"**
3. ูุฏุฎู ุงูุจูุงูุงุช:
   - ุงูุนูุงุฑ: ุจุฑุฌ ูุงุฑููุง
   - ุงููุฆุฉ: Maintenance (ุตูุงูุฉ)
   - ุงููุตู: ุฅุตูุงุญ ูููู ุงูุตุงูุฉ
   - ุงูููุฑุฏ: ุดุฑูุฉ ุงูุชุจุฑูุฏ
   - ุงููุจูุบ: 500 ุฏุฑูู
   - โ ุฎุงุถุน ูุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ
   - ุฑูุน ุฅูุตุงู
4. ูุถุบุท **"Submit"**
5. ุงููุธุงู ูุญุณุจ:
   - Base Amount: 500
   - Tax Amount: 25 (5%)
   - Final Amount: 525
6. ูุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุญุงูุฉ `Pending`
7. ูุฑุณู ุฅุดุนุงุฑ Telegram ููููุงุฉ ุงูุฅุฏุงุฑูุฉ
8. **ุงููุฑุงุฌุน "ูุญูุฏ"** ููุชุญ ุงููุตุฑููุงุช
9. ูุฑุงุฌุน ุงููุตุฑูู
10. ูุถุบุท **"Approve"**
11. ุชุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู `Approved`
12. "ุฃุญูุฏ" ูุณุชูู ุฅุดุนุงุฑ Telegram ุจุงูููุงููุฉ

### **ุงูุณููุงุฑูู ูุน ุทูุจ ุงูุชุตุญูุญ:**

1. **ุงูููุธู "ุณุงูู"** ูุถูู ูุตุฑูู ุจูุจูุบ 1000 ุฏุฑูู
2. **ุงููุฑุงุฌุน "ุนูู"** ูุฌุฏ ุฎุทุฃ ูู ุงููุจูุบ
3. ูุถุบุท **"Needs Correction"**
4. ุงูุญุงูุฉ ุชุชุญูู ุฅูู `Needs Correction`
5. "ุณุงูู" ูุนุฏู ุงููุจูุบ ุฅูู 800 ุฏุฑูู
6. ูุถุบุท **"Submit"** ูุฑุฉ ุฃุฎุฑู
7. ุงูุญุงูุฉ ุชุฑุฌุน ุฅูู `Pending`
8. "ุนูู" ูุฑุงุฌุน ูุฑุฉ ุฃุฎุฑู ูููุงูู

---

## ๐จ **ูุงุฌูุฉ ุงููุณุชุฎุฏู (UI Components)**

### **1. ุตูุญุฉ ูุงุฆูุฉ ุงููุตุฑููุงุช:**
- `expense-management-client.tsx`
- Dashboard Cards (ุฅุญุตุงุฆูุงุช)
- Filters (ุจุญุซุ ููุชุฑุฉ ุญุณุจ ุงูุนูุงุฑ ูุงูุญุงูุฉ)
- ุฌุฏูู ุงููุตุฑููุงุช

### **2. Dialog ุฅุถุงูุฉ/ุชุนุฏูู:**
- `expense-dialog.tsx`
- ูููุฐุฌ ุฅุฏุฎุงู ุงูุจูุงูุงุช
- ุฑูุน ุงูุฅูุตุงู

### **3. ูุงุฆูุฉ ุงููุตุฑููุงุช:**
- `expense-list.tsx`
- ุนุฑุถ ุฌุฏููู
- ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช (View, Edit, Delete, Approve, Reject, Request Correction)

---

## โ **ุงููููุฒุงุช ุงูุญุงููุฉ:**

- โ ูุธุงู ุจุณูุท ูุณูู ุงูุงุณุชุฎุฏุงู
- โ ุญุณุงุจ ุชููุงุฆู ููุถุฑูุจุฉ (5% VAT)
- โ ุฑูุน ุงูุฅูุตุงูุงุช
- โ ุฅุดุนุงุฑุงุช Telegram
- โ ุชุณุฌูู Activity Log
- โ ุตูุงุญูุงุช ูุญููุฉ
- โ ุฅููุงููุฉ ุงูุชุตุญูุญ

---

## โ๏ธ **ุงููููุฏ ุงูุญุงููุฉ:**

- โ๏ธ ูุง ููุฌุฏ workflow ูุนูุฏ (ููุงููุฉ ูุงุญุฏุฉ ููุท)
- โ๏ธ ูุง ููุฌุฏ ุฑุจุท ูุน ุทูุจุงุช ุงูุดุฑุงุก
- โ๏ธ ูุง ููุฌุฏ ููุงููุฉ ูุดุฑูุทุฉ (conditional approval)
- โ๏ธ ูุง ูููู ุฅุฑุฌุงุน ุงููุตุฑูู ูุน ููุงุญุธุงุช ูุญุฏุฏุฉ
- โ๏ธ ูุง ููุฌุฏ ุชุชุจุน ูููุฑุงุฌุน
- โ๏ธ ุงูุฅุดุนุงุฑ ุนูุฏ ุทูุจ ุงูุชุตุญูุญ ููููุฏ

---

**ุชุงุฑูุฎ ุงูุชูุซูู:** 2025-10-09  
**ุงูุฅุตุฏุงุฑ:** 1.0 (Current System)


# ๐ข ูุธุงู ูุฏูุฑ ุงูุนูุงุฑ ูุงููุฏูุฑ ุงูุนุงู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทุจูู ูุธุงู ุดุงูู ูุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช ุญุณุจ ุงูุนูุงุฑุงุช ุงููุนููุฉ ููููุธููู.

---

## ๐ฅ ุฃููุงุน ุงููุฏูุฑูู

### 1. **ูุฏูุฑ ุงูุนูุงุฑ** (Property Manager)
ููุธู ูุนููู ูุฅุฏุงุฑุฉ ุนูุงุฑ ุฃู ุฃูุซุฑ ุจุดูู ูุญุฏุฏ.

**ุงูุตูุงุญูุงุช:**
- โ ูุดุงูุฏ **ููุท** ุงูุนูุงุฑุงุช ุงููุนููุฉ ูู
- โ ูุดุงูุฏ **ููุท** ุงููุณุชุฃุฌุฑูู ูู ุนูุงุฑุงุชู
- โ ูุดุงูุฏ **ููุท** ุงูุฏูุนุงุช ุงููุชุนููุฉ ุจุนูุงุฑุงุชู
- โ ูุดุงูุฏ **ููุท** ุงูุดููุงุช ุงููุชุนููุฉ ุจูุณุชุฃุฌุฑู ุนูุงุฑุงุชู

**ููููุฉ ุงูุชุนููู:**
1. ุงุฐูุจ ุฅูู ุตูุญุฉ ุงูุนูุงุฑ
2. ุงุณุชุฎุฏู ุฎุงุตูุฉ "ุชุนููู ููุธู ููุนูุงุฑ"
3. ุงุฎุชุฑ ุงูููุธู ูู ุงููุงุฆูุฉ

---

### 2. **ุงููุฏูุฑ ุงูุนุงู** (General Manager)
ููุธู ูู ุตูุงุญูุฉ ุงููุตูู ูุฌููุน ุงูุนูุงุฑุงุช.

**ุงูุตูุงุญูุงุช:**
- โ ูุดุงูุฏ **ุฌููุน** ุงูุนูุงุฑุงุช
- โ ูุดุงูุฏ **ุฌููุน** ุงููุณุชุฃุฌุฑูู
- โ ูุดุงูุฏ **ุฌููุน** ุงูุฏูุนุงุช
- โ ูุดุงูุฏ **ุฌููุน** ุงูุดููุงุช

**ููููุฉ ุงูุชุนููู:**
1. ุงุฐูุจ ุฅูู **ุชุนุฏูู ุงูููุธู**
2. ูู ุชุจููุจ **ุงูุตูุงุญูุงุช**
3. ูุนูู ุตูุงุญูุฉ: `properties:read-all` (ูุฏูุฑ ุนุงู - ุนุฑุถ ุฌููุน ุงูุนูุงุฑุงุช)

---

## ๐ ุงูุตูุงุญูุฉ ุงูุฌุฏูุฏุฉ

### **`properties:read-all`**

| ุงููุบุฉ | ุงููุต |
|------|------|
| ๐ธ๐ฆ ุงูุนุฑุจูุฉ | **ูุฏูุฑ ุนุงู - ุนุฑุถ ุฌููุน ุงูุนูุงุฑุงุช** |
| ๐ฌ๐ง English | **General Manager - View All Properties** |

**ุงููููุน:** 
- ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช โ Property Management
- ุชุธูุฑ ูู ูููุฐุฌ ุชุนุฏูู ุงูููุธู โ ุชุจููุจ ุงูุตูุงุญูุงุช

---

## ๐ ูุง ุชู ุชุทุจููู ุชูููุงู

### 1. **ุฏูุงู Helper ุฌุฏูุฏุฉ** (`permissions.ts`)

```typescript
// ุงูุชุญูู ุฅุฐุง ูุงู ุงูููุธู ูุฏูุฑ ุนุงู
isGeneralManager(employee): boolean

// ุงูุชุญูู ุฅุฐุง ูุงู ุงูููุธู ูุฏูุฑ ูุนูุงุฑ ูุนูู
isPropertyManager(employee, propertyId, assignedPropertyIds): boolean

// ุชุตููุฉ ุงูุนูุงุฑุงุช ุญุณุจ ุตูุงุญูุงุช ุงูููุธู
filterPropertiesByEmployee(properties, employee, assignedPropertyIds): Property[]
```

### 2. **ุฏูุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ** (`db.ts`)

#### **ุงูุนูุงุฑุงุช:**
```typescript
getProperties(employeeId?: string): Promise<Property[]>
// ุฅุฐุง ุชู ุชูุฑูุฑ employeeIdุ ุชูุฑุฌุน ููุท ุงูุนูุงุฑุงุช ุงููุนููุฉ ูู
```

####  **ุงููุณุชุฃุฌุฑูู:**
```typescript
getTenants(employeeId?: string): Promise<Tenant[]>
// ุชูุตูู ุงููุณุชุฃุฌุฑูู ุญุณุจ ุงูุนูุงุฑุงุช ุงููุนููุฉ ููููุธู
```

#### **ุงูุฏูุนุงุช:**
```typescript
getAllLeasePaymentsWithDetails(employeeId?: string): Promise<LeasePayment[]>
// ุชูุตูู ุงูุฏูุนุงุช ุญุณุจ ุงูุนูุงุฑุงุช ุงููุนููุฉ ููููุธู
```

#### **ุงูุดููุงุช:**
```typescript
getCheques({ createdById, employeeId }): Promise<Cheque[]>
// ุชูุตูู ุงูุดููุงุช ุญุณุจ ุงููุณุชุฃุฌุฑูู ูู ุงูุนูุงุฑุงุช ุงููุนููุฉ ููููุธู
```

#### **ุฏุงูุฉ ูุณุงุนุฏุฉ:**
```typescript
getPropertyIdsForEmployee(employeeId: string): Promise<string[]>
// ุชูุฑุฌุน ููุท ูุนุฑูุงุช ุงูุนูุงุฑุงุช (ุฃุฎู ูู getPropertiesForEmployee)
```

---

## ๐ฏ ุณููุงุฑูููุงุช ุงูุงุณุชุฎุฏุงู

### **ุณููุงุฑูู 1: ูุฏูุฑ ุนูุงุฑ ูุงุญุฏ**

**ุงููุทููุจ:**
- ููุธู ูุฏูุฑ ุนูุงุฑ "ุจุฑุฌ ุงูุฃูู" ููุท

**ุงูุฎุทูุงุช:**
1. ูู ุจุชุนููู ุงูููุธู ูุนูุงุฑ "ุจุฑุฌ ุงูุฃูู"
2. **ูุง ุชูุนูู** ุตูุงุญูุฉ `properties:read-all`

**ุงููุชูุฌุฉ:**
- ูุฑู ููุท ุนูุงุฑ "ุจุฑุฌ ุงูุฃูู"
- ูุฑู ููุท ูุณุชุฃุฌุฑู "ุจุฑุฌ ุงูุฃูู"
- ูุฑู ููุท ุฏูุนุงุช ูุดููุงุช "ุจุฑุฌ ุงูุฃูู"

---

### **ุณููุงุฑูู 2: ูุฏูุฑ ุนุฏุฉ ุนูุงุฑุงุช**

**ุงููุทููุจ:**
- ููุธู ูุฏูุฑ 3 ุนูุงุฑุงุช: "ุจุฑุฌ ุงูุฃูู"ุ "ูุฌูุน ุงูููุฑ"ุ "ููู ุงูุฑูุงู"

**ุงูุฎุทูุงุช:**
1. ูู ุจุชุนููู ุงูููุธู ููู ุนูุงุฑ ูู ุงูุซูุงุซุฉ
2. **ูุง ุชูุนูู** ุตูุงุญูุฉ `properties:read-all`

**ุงููุชูุฌุฉ:**
- ูุฑู ููุท ุงูุนูุงุฑุงุช ุงูุซูุงุซุฉ
- ูุฑู ููุท ูุณุชุฃุฌุฑู ูุฐู ุงูุนูุงุฑุงุช
- ูุฑู ููุท ุฏูุนุงุช ูุดููุงุช ูุฐู ุงูุนูุงุฑุงุช

---

### **ุณููุงุฑูู 3: ูุฏูุฑ ุนุงู**

**ุงููุทููุจ:**
- ููุธู ูุดุฑู ุนูู ุฌููุน ุงูุนูุงุฑุงุช (ูุฏูุฑ ุงูุดุฑูุฉ)

**ุงูุฎุทูุงุช:**
1. **ูุนูู** ุตูุงุญูุฉ `properties:read-all` ููููุธู
2. ูุง ุญุงุฌุฉ ูุชุนูููู ููู ุนูุงุฑ

**ุงููุชูุฌุฉ:**
- ูุฑู **ุฌููุน** ุงูุนูุงุฑุงุช ูู ุงููุธุงู
- ูุฑู **ุฌููุน** ุงููุณุชุฃุฌุฑูู
- ูุฑู **ุฌููุน** ุงูุฏูุนุงุช ูุงูุดููุงุช

---

### **ุณููุงุฑูู 4: ูุฏูุฑ + ุตูุงุญูุงุช ูุญุฏูุฏุฉ**

**ุงููุทููุจ:**
- ููุธู ูุฏูุฑ ุนุงู ููู ุจุฏูู ุตูุงุญูุฉ ุญุฐู

**ุงูุฎุทูุงุช:**
1. **ูุนูู** `properties:read-all`
2. **ูุง ุชูุนูู** ุตูุงุญูุงุช ุงูุญุฐู (`properties:delete`, `tenants:delete`, ุฅูุฎ)

**ุงููุชูุฌุฉ:**
- ูุฑู ูู ุดูุก
- ููู ูุง ูุณุชุทูุน ุญุฐู ุฃู ุดูุก

---

## ๐ ููู ูุนูู ุงููุธุงู ุฎูู ุงูููุงููุณ

### **ุนูุฏ ูุฑุงุกุฉ ุงูุนูุงุฑุงุช:**

```sql
-- ุฅุฐุง ูุงู ุงูููุธู ูุฏูุฑ ุนุงู (ูุฏูู properties:read-all)
SELECT * FROM properties ORDER BY name;

-- ุฅุฐุง ูุงู ูุฏูุฑ ุนูุงุฑ ูุนูู
SELECT * FROM properties p
WHERE EXISTS (
  SELECT 1 FROM employee_properties ep
  WHERE ep.propertyId = p.id AND ep.employeeId = ?
)
ORDER BY name;
```

### **ุนูุฏ ูุฑุงุกุฉ ุงููุณุชุฃุฌุฑูู:**

```sql
-- ูุฏูุฑ ุนูุงุฑ ูุฑู ููุท ูุณุชุฃุฌุฑู ุนูุงุฑุงุชู
SELECT DISTINCT t.* FROM tenants t
WHERE EXISTS (
  SELECT 1 FROM leases l
  JOIN units u ON l.unitId = u.id
  JOIN employee_properties ep ON u.propertyId = ep.propertyId
  WHERE l.tenantId = t.id AND ep.employeeId = ?
)
ORDER BY t.name;
```

### **ุนูุฏ ูุฑุงุกุฉ ุงูุฏูุนุงุช:**

```sql
-- ูุฏูุฑ ุนูุงุฑ ูุฑู ููุท ุฏูุนุงุช ุนูุงุฑุงุชู
SELECT lp.*, p.name AS propertyName, ...
FROM lease_payments lp
JOIN leases l ON lp.leaseId = l.id
JOIN units u ON l.unitId = u.id
JOIN properties p ON u.propertyId = p.id
WHERE EXISTS (
  SELECT 1 FROM employee_properties ep
  WHERE ep.propertyId = p.id AND ep.employeeId = ?
)
ORDER BY lp.dueDate DESC;
```

### **ุนูุฏ ูุฑุงุกุฉ ุงูุดููุงุช:**

```sql
-- ูุฏูุฑ ุนูุงุฑ ูุฑู ููุท ุดููุงุช ูุณุชุฃุฌุฑู ุนูุงุฑุงุชู
SELECT c.*, ...
FROM cheques c
WHERE EXISTS (
  SELECT 1 FROM leases l
  JOIN units u ON l.unitId = u.id
  JOIN employee_properties ep ON u.propertyId = ep.propertyId
  WHERE l.tenantId = c.tenantId AND ep.employeeId = ?
)
ORDER BY c.dueDate ASC;
```

---

## โก ุฃุฏุงุก ุงููุธุงู

### **ุงูุชุญุณููุงุช:**
- โ ุงุณุชุฎุฏุงู `EXISTS` ุจุฏูุงู ูู `JOIN` ููุชุตููุฉ (ุฃุณุฑุน)
- โ ุฏุงูุฉ `getPropertyIdsForEmployee` ุฎูููุฉ (ุชูุฑุฌุน ูุนุฑูุงุช ููุท)
- โ ุงูุชุตููุฉ ุชุชู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ููุณ ูู ุงูุชุทุจูู)

### **ุงูููุงุฑุณ ุงูููุตู ุจูุง:**
```sql
-- ูุชุณุฑูุน ุงูุงุณุชุนูุงูุงุช
CREATE INDEX idx_employee_properties_employee ON employee_properties(employeeId);
CREATE INDEX idx_employee_properties_property ON employee_properties(propertyId);
CREATE INDEX idx_units_property ON units(propertyId);
CREATE INDEX idx_leases_unit ON leases(unitId);
CREATE INDEX idx_leases_tenant ON leases(tenantId);
```

---

## ๐จ ุงููุงุฌูุฉ ุงูุฃูุงููุฉ

### **ูุง ูุญุชุงุฌ ุชุญุฏูุซ:**
ูุฌุจ ุชูุฑูุฑ `employeeId` ููุฏูุงู ุงููุญุฏุซุฉ ูู ุงูุตูุญุงุช ุงูุชุงููุฉ:

1. **ุตูุญุฉ ุงูุนูุงุฑุงุช** (`/dashboard/properties`)
   ```typescript
   const properties = await getProperties(employee.id);
   ```

2. **ุตูุญุฉ ุงููุณุชุฃุฌุฑูู** (`/dashboard/tenants`)
   ```typescript
   const tenants = await getTenants(employee.id);
   ```

3. **ุตูุญุฉ ุงูุฏูุนุงุช** (`/dashboard/payments`)
   ```typescript
   const payments = await getAllLeasePaymentsWithDetails(employee.id);
   ```

4. **ุตูุญุฉ ุงูุดููุงุช** (`/dashboard/cheques`)
   ```typescript
   const cheques = await getCheques({ employeeId: employee.id });
   ```

โ๏ธ **ููุงุญุธุฉ:** ุชุฃูุฏ ูู ูุญุต ุตูุงุญูุฉ `properties:read-all` ูุจู ุงูุชุตููุฉ:
```typescript
import { isGeneralManager } from '@/lib/permissions';

// ุฅุฐุง ูุงู ูุฏูุฑ ุนุงูุ ูุง ุชููุฑุฑ employeeId
const employeeIdForFilter = isGeneralManager(employee) ? undefined : employee.id;
const properties = await getProperties(employeeIdForFilter);
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### **ุณููุงุฑูู ุงูุงุฎุชุจุงุฑ 1:**
1. ุฃูุดุฆ ููุธู ุฌุฏูุฏ
2. ูุง ุชูุนูู `properties:read-all`
3. ุนูููู ูุนูุงุฑ ูุงุญุฏ
4. ุณุฌูู ุฏุฎููู โ ูุฌุจ ุฃู ูุฑู ุนูุงุฑ ูุงุญุฏ ููุท

### **ุณููุงุฑูู ุงูุงุฎุชุจุงุฑ 2:**
1. ููุณ ุงูููุธู
2. ูุนูู `properties:read-all`
3. ุณุฌูู ุฏุฎููู โ ูุฌุจ ุฃู ูุฑู ุฌููุน ุงูุนูุงุฑุงุช

---

## ๐ ููุฎุต ุงูุชุบููุฑุงุช

| ุงูููู | ุงูุชุบููุฑุงุช |
|------|-----------|
| `permissions.ts` | โ ุฅุถุงูุฉ ุตูุงุญูุฉ `properties:read-all`<br>โ 4 ุฏูุงู helper ุฌุฏูุฏุฉ |
| `db.ts` | โ ุชุญุฏูุซ `getProperties()`<br>โ ุชุญุฏูุซ `getTenants()`<br>โ ุชุญุฏูุซ `getAllLeasePaymentsWithDetails()`<br>โ ุชุญุฏูุซ `getCheques()`<br>โ ุฅุถุงูุฉ `getPropertyIdsForEmployee()` |
| `language-context.tsx` | โ ุชุฑุฌูุฉ ุนุฑุจูุฉ<br>โ ุชุฑุฌูุฉ ุฅูุฌููุฒูุฉ |

---

## โ ุงูุญุงูุฉ

- ๐ฏ **ุงููุธุงู ููุชูู 100%**
- ๐ง **ุฌุงูุฒ ููุชุทุจูู**
- โ๏ธ **ูุญุชุงุฌ ุชุญุฏูุซ ุตูุญุงุช ุงููุงุฌูุฉ ุงูุฃูุงููุฉ**

---

**ุขุฎุฑ ุชุญุฏูุซ:** 8 ุฃูุชูุจุฑ 2025

